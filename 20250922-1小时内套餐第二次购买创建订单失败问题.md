# 20250922-1小时内套餐第二次购买创建订单失败问题



# 1、问题背景

观察日志发现请求购买套餐异常日志增多



#### **1.1 关联需求链接**

链接：https://cooper.didichuxing.com/knowledge/2204291401492/2204196789269



# 2、时间轴（北京时间）



## **2.1 问题发生**

首次发生：2025-10-22 22:46:26.074 

 https://monitor.xiaojukeji.com/#/dashboard/logRetrival/trace?date=2025-10-22&idc=us&monitorEnv=USA&traceId=0a0f162f68f8ee4284fcf59303f42602

 



## **2.2 报警时间**

2025-10-22 22:46:26.074  ——  2025-10-23 15:33:07.881

 https://monitor.xiaojukeji.com/#/dashboard/logRetrival/trace?date=2025-10-22&idc=us&monitorEnv=USA&traceId=0a0f162f68f8ee4284fcf59303f42602

共321条日志



## **2.3 问题发现**

自动续订atom-api 上线后观察日志发现请求购买套餐异常日志增多

 

 



## **2.4 问题响应**

2025-10-23 10:00 开始排查 

2025-10-23 13:15:51 开始上线异常处理代码



 

 



## **2.5 问题定位**

2025-10-23 10:15 定位到 清除旧订单缓存时使用的key还是更新前的key，导致删除订单redis缓存失败





 



## **2.6 问题止损**

2025-10-23 10:40 提交新逻辑进行拦截

2025-10-23 13:15:51 开始上线异常处理代码







##  



## **2.7 问题善后（如需要）**

无需善后

 



##  



## 2.8 问题及时性处理总结

MTTD（发现时间-发生时间）: 11 小时 13 分钟 

MTTR（止损时间-发现时间）: 2 小时 35 分钟 51 秒



# 3、影响范围



## 3.1 订单影响

订单损失总量：无

明细：

 

| 国家 | 呼叫或完单 |
| ---- | ---------- |
|      |            |



## 3.2 资损影响

资损总量：无

明细：

 

| 国家 | 资损 |
| ---- | ---- |
| MX   |      |



## 3.3 用户体验影响

影响场景：1小时内购买两次以上同套餐

用户总数：107人 

明细：

369435933451336、369436218352043、369436872873756、369436444466019 、369435965828816、369436046409216、369436869961396、369436228580364、369436633649247、369436581796559、369436729631594、351843721205548、369436716997175、369436805364957、369436102371808、369435957180454、

369436511082989、369435939264590、、369435948756909、369435915501047、369436732968530、369436094195817、369436732968530、369435923070975、369436083515608、369436268626840、369436474673235、369436361859169、369436639065311、369436339663306、369436780063175、360287970197604409、369436801096472、369436588667077、369436129057044、369436635330039、369436838658011、369436673810696、351843740304691、369436634001610、369436772994481、369436194690384、351843736448838、351843748474773、369436524945607、369435909091317、369436687855438、351843736277875、369436133836051、369435928160985、369436110182464、369436582684852、369436346267600、369436208764834、369436504773074、369435990444141、369436739965960、369436349490943、369436349490943、369435998149655、369436862704416、369436243530367、369436400336767、369435914705532、

369436262621205、369435967964840、351843735308999、369436564012456、351843749672116、369436564012456、369436092413580、369435910327812、369436390393797、369435999220955、369436221763632、369436675302612、369436502515017、369436242614471、369436066861199、351843741769041、369435933683478、369436032364681、369436734614217、369436097034745、369436871729729、351843742742824、369435918541948、369435960401753、369436592715850、369436409914347、369436246380596、369435972110925、369436632339585、369436048743223、369436024571987、369435972343871、369436184006846、369436460995615、369436084919924、369436137238913、369436505402131、369436217364314、369436217364314、369435910870268、369435910870268、369435921301637、369436796799136、369436047068241

| 国家 | 用户数 |
| ---- | ------ |
| BR   | 107    |



## 3.4 其他影响

 



# 4、根因分析（需要梳理出架构和链路，错误代码需要贴出来）

根因描述

引入的新缓存没有正确删除

![img](https://didoc.didichuxing.com/api/uploadfile?b=didoc-upload-image-prod&k=17612307961493a948e73-e416-4633-a4dd-06209494fff2%2Fimage.png&token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjbGllbnRJZCI6IjVnQTdCaXhpODk2MXZ4MW1ubFVNQlp1cEZOYXJZQW5KIiwidXNlcm5hbWUiOiJsdW9iaWFvX2kiLCJkb2NJZCI6Ijc2NTExNDAiLCJpYXQiOjE3NzE0MzA5MDEsImV4cCI6MTc3MjAzNTcwMX0.0QGzkooBRNkrpK-OQeTwRez7eYLFgF3DxqH1wcF74c4)





# 5、问题反思

RD:  考虑引入新缓存的时候要对于缓存的全部生命周期进行考虑，删除 更新等操作一定要检查

QA：



# 6、待改进项 